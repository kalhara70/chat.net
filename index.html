<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NILLA.ai â€” Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getDatabase, ref, set, get, push, onValue, off, serverTimestamp, remove
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

// ğŸ”¥ REPLACE WITH YOUR FIREBASE CONFIG
 const firebaseConfig = {
    apiKey: "AIzaSyBr5LtEwkHDau2oUcSK0czVZH76qjdM6-8",
    authDomain: "ap-cont.firebaseapp.com",
    databaseURL: "https://ap-cont-default-rtdb.firebaseio.com",
    projectId: "ap-cont",
    storageBucket: "ap-cont.appspot.com",
    messagingSenderId: "325531671266",
    appId: "1:325531671266:web:9a0ffa629fc2d730c89cbb",
    measurementId: "G-BK71M75BK3"
  };


const app      = initializeApp(firebaseConfig);
const auth     = getAuth(app);
const db       = getDatabase(app);
const provider = new GoogleAuthProvider();

// â”€â”€ Global State â”€â”€
let ME             = null;
let myContacts     = {};   // contacts I added or who messaged me
let allUsers       = {};   // all registered users (for search)
let activeChatId   = null;
let activeOtherUid = null;
let msgUnsubFn     = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function shortId(uid)  { return uid.substring(0,8).toUpperCase(); }
function chatId(a,b)   { return [a,b].sort().join('__'); }

const COLS = ['ac0','ac1','ac2','ac3','ac4','ac5'];
function acol(n){ let h=0; for(const c of String(n||'')) h=(h<<5)-h+c.charCodeAt(0); return COLS[Math.abs(h)%6]; }
function ini(n) { return String(n||'').split(' ').slice(0,2).map(w=>w[0]||'').join('').toUpperCase()||'?'; }
function esc(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function fmtTime(ts){ if(!ts) return 'now'; return new Date(typeof ts==='number'?ts:Date.now()).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}); }
function fmtDay(ts){
  if(!ts) return 'Today';
  const d=new Date(typeof ts==='number'?ts:Date.now()), t=new Date();
  if(d.toDateString()===t.toDateString()) return 'Today';
  const y=new Date(t); y.setDate(t.getDate()-1);
  if(d.toDateString()===y.toDateString()) return 'Yesterday';
  return d.toLocaleDateString([],{month:'short',day:'numeric',year:'numeric'});
}
function fmtSize(b){ if(b<1024) return b+'B'; if(b<1048576) return (b/1024).toFixed(1)+'KB'; return (b/1048576).toFixed(1)+'MB'; }

function mkAva(user, sz=42, fsz='.9rem') {
  const st=`width:${sz}px;height:${sz}px;border-radius:50%;font-size:${fsz};font-weight:700;color:#fff;overflow:hidden;border:2px solid rgba(0,212,255,.18);display:flex;align-items:center;justify-content:center;flex-shrink:0;`;
  return user?.photo
    ? `<div style="${st}"><img src="${esc(user.photo)}" style="width:100%;height:100%;object-fit:cover;border-radius:50%"></div>`
    : `<div class="${acol(user?.name||'')}" style="${st}">${ini(user?.name||'?')}</div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.doGoogleSignIn = async () => {
  try {
    setBtnLoad(true);
    const { user } = await signInWithPopup(auth, provider);
    // Save/update user profile
    await set(ref(db, `nilla_users/${user.uid}`), {
      uid:     user.uid,
      shortId: shortId(user.uid),
      name:    user.displayName || 'User',
      email:   user.email || '',
      photo:   user.photoURL || '',
      online:  true,
      lastSeen: serverTimestamp()
    });
  } catch(e) {
    setBtnLoad(false);
    showAuthErr(e.code === 'auth/popup-closed-by-user' ? 'Cancelled.' : e.message);
  }
};

window.doSignOut = async () => {
  if (ME) {
    await set(ref(db, `nilla_users/${ME.uid}/online`), false);
    await set(ref(db, `nilla_users/${ME.uid}/lastSeen`), serverTimestamp());
  }
  if (msgUnsubFn) { try { off(ref(db, `nilla_chats/${activeChatId}/messages`)); } catch(e){} msgUnsubFn = null; }
  myContacts = {}; allUsers = {}; ME = null; activeChatId = null; activeOtherUid = null;
  await signOut(auth);
};

onAuthStateChanged(auth, async user => {
  if (user) {
    ME = {
      uid:     user.uid,
      name:    user.displayName || 'User',
      email:   user.email || '',
      photo:   user.photoURL || '',
      shortId: shortId(user.uid)
    };
    setBtnLoad(false);
    bootApp();
  } else {
    showLoginScreen();
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function bootApp() {
  showAppScreen();

  // Mark online
  await set(ref(db, `nilla_users/${ME.uid}/online`), true);

  // Listen ALL users (for search only â€” not shown in list)
  onValue(ref(db, 'nilla_users'), snap => {
    allUsers = snap.val() || {};
  });

  // â”€â”€ Listen MY contacts â”€â”€
  // Stored at: nilla_contacts/{myUid}/{theirUid} = true
  // This fires whenever someone is added (including auto-add from receiving a message)
  onValue(ref(db, `nilla_contacts/${ME.uid}`), async snap => {
    const data = snap.val() || {};
    const uids = Object.keys(data);

    // Fetch each contact's profile from nilla_users
    const newContacts = {};
    for (const uid of uids) {
      const s = await get(ref(db, `nilla_users/${uid}`));
      if (s.exists()) newContacts[uid] = s.val();
    }
    myContacts = newContacts;
    renderContactList();

    // If active chat partner was removed, close chat
    if (activeOtherUid && !myContacts[activeOtherUid]) closeChatPanel();
  });

  // â”€â”€ Listen for INCOMING messages across all chats I'm in â”€â”€
  // When someone sends me a message, auto-add them to my contacts
  onValue(ref(db, `nilla_inbox/${ME.uid}`), async snap => {
    const data = snap.val() || {};
    for (const senderUid of Object.keys(data)) {
      if (!myContacts[senderUid]) {
        // Auto-add sender to my contacts
        await set(ref(db, `nilla_contacts/${ME.uid}/${senderUid}`), true);
      }
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ADD CONTACT (manual â€” sender side)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.searchAndAdd = async () => {
  const val = (document.getElementById('addIdInput').value || '').trim().toUpperCase().replace('#','');
  const res = document.getElementById('findResult');
  if (!val) { res.innerHTML = `<div class="find-err">Enter an ID first.</div>`; return; }

  const found = Object.values(allUsers).find(u => u.shortId === val && u.uid !== ME.uid);
  if (!found) {
    res.innerHTML = `<div class="find-err">âŒ No user found with ID <strong>#${esc(val)}</strong></div>`;
    return;
  }
  if (myContacts[found.uid]) {
    res.innerHTML = `<div class="find-err" style="color:var(--warn)">âš ï¸ Already in your contacts!</div>`;
    return;
  }

  res.innerHTML = `
    <div class="found-card">
      ${mkAva(found, 40, '.88rem')}
      <div style="flex:1;min-width:0">
        <div style="font-weight:600;font-size:.88rem">${esc(found.name)}</div>
        <div style="font-size:.72rem;color:var(--muted)">#${esc(found.shortId)} Â· ${esc(found.email)}</div>
      </div>
      <button class="btn-teal-sm" onclick="confirmAdd('${found.uid}')">Add &amp; Chat</button>
    </div>`;
};

window.confirmAdd = async uid => {
  // Add to MY contacts
  await set(ref(db, `nilla_contacts/${ME.uid}/${uid}`), true);
  // NOTE: Receiver gets auto-added when I send first message
  closeAddModal();
  showToast('Contact added! âœ“', true);
  // Open chat immediately
  await waitForContact(uid);
};

async function waitForContact(uid) {
  let tries = 0;
  const wait = () => new Promise(r => setTimeout(r, 200));
  while (!myContacts[uid] && tries < 15) { await wait(); tries++; }
  if (myContacts[uid]) openChat(uid);
}

window.removeContact = async uid => {
  if (!confirm('Remove this contact?')) return;
  await remove(ref(db, `nilla_contacts/${ME.uid}/${uid}`));
  if (activeOtherUid === uid) closeChatPanel();
  showToast('Contact removed', true);
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER CONTACT LIST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.renderContactList = function() {
  const q   = (document.getElementById('searchContacts')?.value || '').toLowerCase();
  const box = document.getElementById('contactList');

  const list = Object.values(myContacts).filter(u =>
    (u.name || '').toLowerCase().includes(q) ||
    (u.shortId || '').toLowerCase().includes(q)
  );

  if (!list.length) {
    box.innerHTML = `<div class="empty-list">${
      q
        ? 'No contacts match your search.'
        : `<div style="padding-top:30px">
            <div style="font-size:1.6rem;margin-bottom:10px">ğŸ’¬</div>
            <div>No contacts yet.</div>
            <div style="margin-top:8px">Tap <strong style="color:var(--cyan)">+</strong> and enter a friend's ID to start chatting!</div>
            <div style="margin-top:8px;font-size:.75rem;opacity:.7">Or share your ID and they'll appear here automatically when they message you.</div>
          </div>`
    }</div>`;
    return;
  }

  box.innerHTML = list.map((u, i) => {
    const cid    = chatId(ME.uid, u.uid);
    const active = cid === activeChatId;
    const online = allUsers[u.uid]?.online === true;
    return `
      <div class="contact-row ${active ? 'active' : ''}"
           onclick="openChat('${u.uid}')"
           style="animation-delay:${i*0.04}s">
        <div style="position:relative;flex-shrink:0">
          ${mkAva(u, 42, '.88rem')}
          <div class="odot ${online ? 'on' : 'off'}"></div>
        </div>
        <div class="c-inf">
          <div class="c-nm">${esc(u.name || 'Unknown')}</div>
          <div class="c-id">#${esc(u.shortId || '')}</div>
        </div>
        <button class="rm-btn" title="Remove"
          onclick="event.stopPropagation(); removeContact('${u.uid}')">
          <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M18 6 6 18M6 6l12 12"/>
          </svg>
        </button>
      </div>`;
  }).join('');
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  OPEN CHAT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.openChat = function(otherUid) {
  const other = myContacts[otherUid];
  if (!other) return;

  activeChatId   = chatId(ME.uid, otherUid);
  activeOtherUid = otherUid;
  renderContactList();

  document.getElementById('chatWelcome').style.display = 'none';
  const cb = document.getElementById('chatBox');
  cb.style.cssText = 'display:flex;flex-direction:column;flex:1;overflow:hidden;';

  // Live online status
  onValue(ref(db, `nilla_users/${otherUid}/online`), snap => {
    const el = document.getElementById('hdrStatus');
    if (el) el.innerHTML = snap.val() === true
      ? `<span style="color:var(--success)">â— Online</span>`
      : `<span style="color:var(--muted)">â— Offline</span>`;
  });

  document.getElementById('chatHeader').innerHTML = `
    <div class="ch-l">
      <div style="position:relative">
        ${mkAva(other, 38, '.88rem')}
        <div class="odot ${allUsers[otherUid]?.online ? 'on' : 'off'}" style="bottom:0;right:0;border-color:var(--bg)"></div>
      </div>
      <div>
        <div style="font-weight:600;font-size:.94rem">${esc(other.name || 'â€”')}</div>
        <div id="hdrStatus" style="font-size:.71rem;margin-top:2px">
          ${allUsers[otherUid]?.online
            ? `<span style="color:var(--success)">â— Online</span>`
            : `<span style="color:var(--muted)">â— Offline</span>`}
          <span style="color:var(--muted);margin-left:8px">#${esc(other.shortId || '')}</span>
        </div>
      </div>
    </div>
    <button class="icon-btn" onclick="closeChatPanel()">
      <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path d="M18 6 6 18M6 6l12 12"/>
      </svg>
    </button>`;

  // Unsubscribe old
  if (msgUnsubFn) {
    try { off(ref(db, `nilla_chats/${activeChatId}/messages`)); } catch(e){}
    msgUnsubFn = null;
  }
  document.getElementById('msgArea').innerHTML = '';

  // Listen messages
  const msgsRef = ref(db, `nilla_chats/${activeChatId}/messages`);
  msgUnsubFn = onValue(msgsRef, snap => {
    const data = snap.val() || {};
    const msgs = Object.entries(data)
      .map(([id, v]) => ({ id, ...v }))
      .sort((a, b) => (a.ts || 0) - (b.ts || 0));
    renderMessages(msgs, other);
  });

  setTimeout(() => document.getElementById('msgInput')?.focus(), 80);
};

window.closeChatPanel = function() {
  if (msgUnsubFn) {
    try { off(ref(db, `nilla_chats/${activeChatId}/messages`)); } catch(e){}
    msgUnsubFn = null;
  }
  activeChatId = null; activeOtherUid = null;
  document.getElementById('chatBox').style.display     = 'none';
  document.getElementById('chatWelcome').style.display = 'flex';
  renderContactList();
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER MESSAGES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMessages(msgs, other) {
  const area = document.getElementById('msgArea');
  if (!msgs.length) {
    area.innerHTML = `<div class="day-sep">Say hello! ğŸ‘‹</div>`;
    return;
  }

  let html = '', lastDay = '';
  msgs.forEach(m => {
    const isMe = m.sender === ME.uid;
    const day  = fmtDay(m.ts);
    if (day !== lastDay) { html += `<div class="day-sep">${day}</div>`; lastDay = day; }

    const uObj = isMe
      ? { name: ME.name,    photo: ME.photo }
      : { name: other.name, photo: other.photo };

    let body = '';
    if (m.type === 'text') {
      body = `<div class="bbl ${isMe ? 'me' : 'them'}">${esc(m.text).replace(/\n/g, '<br>')}</div>`;
    } else if (m.type === 'image') {
      body = `<div class="media-wrap" onclick="openLb('${m.src}')">
        <img src="${m.src}" style="max-width:220px;max-height:210px;border-radius:12px;display:block;cursor:zoom-in">
      </div>`;
    } else if (m.type === 'file') {
      body = `<div class="file-row" onclick="dlFile('${m.src}','${esc(m.name)}')">
        <span style="font-size:1.3rem">ğŸ“</span>
        <div><div class="fn">${esc(m.name)}</div><div class="fsz">${m.size || ''}</div></div>
      </div>`;
    }

    html += `
      <div class="msg-r ${isMe ? 'me' : 'them'}">
        ${!isMe ? mkAva(uObj, 27, '.65rem') : ''}
        <div class="msg-col">
          ${body}
          <div class="msg-meta">
            ${fmtTime(m.ts)}
            ${isMe ? '<span style="color:var(--cyan)">âœ“âœ“</span>' : ''}
          </div>
        </div>
        ${isMe ? mkAva(uObj, 27, '.65rem') : ''}
      </div>`;
  });

  area.innerHTML = html;
  area.scrollTop = area.scrollHeight;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SEND MESSAGE â€” KEY LOGIC: auto-add receiver
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doSend(msgData) {
  if (!ME || !activeChatId || !activeOtherUid) return;

  const msg = { ...msgData, sender: ME.uid, ts: serverTimestamp() };

  // 1. Save message to shared chat room
  await push(ref(db, `nilla_chats/${activeChatId}/messages`), msg);

  // 2. Notify receiver's inbox â†’ triggers auto-add on their side
  //    nilla_inbox/{receiverUid}/{senderUid} = timestamp
  await set(ref(db, `nilla_inbox/${activeOtherUid}/${ME.uid}`), serverTimestamp());

  // 3. Make sure receiver is in MY contacts too (in case I started fresh)
  await set(ref(db, `nilla_contacts/${ME.uid}/${activeOtherUid}`), true);
}

window.sendMsg = async () => {
  const inp  = document.getElementById('msgInput');
  const text = inp.value.trim();
  if (!text) return;
  inp.value = ''; inp.style.height = 'auto';
  await doSend({ type: 'text', text });
};

window.handleImg = input => {
  const file = input.files[0]; if (!file || !activeChatId) return;
  const reader = new FileReader();
  reader.onload = e => {
    const img = new Image();
    img.onload = async () => {
      const MAX = 700;
      let w = img.width, h = img.height;
      if (w > MAX || h > MAX) {
        if (w > h) { h = Math.round(h * MAX / w); w = MAX; }
        else       { w = Math.round(w * MAX / h); h = MAX; }
      }
      const cv = document.createElement('canvas');
      cv.width = w; cv.height = h;
      cv.getContext('2d').drawImage(img, 0, 0, w, h);
      await doSend({ type: 'image', src: cv.toDataURL('image/jpeg', 0.78) });
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file); input.value = '';
};

window.handleFile = input => {
  const file = input.files[0]; if (!file || !activeChatId) return;
  const reader = new FileReader();
  reader.onload = async e => {
    await doSend({ type: 'file', src: e.target.result, name: file.name, size: fmtSize(file.size) });
  };
  reader.readAsDataURL(file); input.value = '';
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UI HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showLoginScreen() {
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('appScreen').style.display   = 'none';
}

function showAppScreen() {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('appScreen').style.display   = 'flex';
  document.getElementById('myName').textContent    = ME.name;
  document.getElementById('myEmail').textContent   = ME.email;
  document.getElementById('myShortId').textContent = '#' + ME.shortId;
  document.getElementById('myIdInline').textContent = '#' + ME.shortId;
  const ava = document.getElementById('myAva');
  ava.innerHTML = ME.photo
    ? `<img src="${ME.photo}" style="width:100%;height:100%;border-radius:50%;object-fit:cover">`
    : ini(ME.name || 'U');
}

function setBtnLoad(on) {
  const btn = document.getElementById('googleBtn');
  btn.disabled = on;
  btn.innerHTML = on
    ? `<div class="spin"></div><span>Signing inâ€¦</span>`
    : `<svg width="20" height="20" viewBox="0 0 24 24">
        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
      </svg><span>Continue with Google</span>`;
}

function showAuthErr(msg) {
  const el = document.getElementById('authErr');
  el.textContent = msg; el.style.display = 'block';
  setTimeout(() => el.style.display = 'none', 4500);
}

window.openAddModal  = () => {
  document.getElementById('addModal').style.display = 'flex';
  document.getElementById('findResult').innerHTML   = '';
  document.getElementById('addIdInput').value       = '';
  setTimeout(() => document.getElementById('addIdInput').focus(), 80);
};
window.closeAddModal = () => { document.getElementById('addModal').style.display = 'none'; };
window.copyMyId      = () => {
  navigator.clipboard.writeText('#' + (ME?.shortId || ''))
    .then(() => showToast('ID copied! Share with friends ğŸ”—', true));
};
window.openLb  = src => { document.getElementById('lb').style.display = 'flex'; document.getElementById('lbImg').src = src; };
window.closeLb = ()  => { document.getElementById('lb').style.display = 'none'; };
window.dlFile  = (src, name) => { const a = document.createElement('a'); a.href = src; a.download = name; a.click(); };
window.autoH   = el => { el.style.height = 'auto'; el.style.height = Math.min(el.scrollHeight, 120) + 'px'; };
window.keydown = e  => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMsg(); } };
window.toggleEm = () => {
  const p = document.getElementById('emojiPad');
  p.style.display = p.style.display === 'grid' ? 'none' : 'grid';
};
window.addEmoji = e => {
  const i = document.getElementById('msgInput');
  i.value += e; i.focus();
  document.getElementById('emojiPad').style.display = 'none';
};

let toastT;
window.showToast = (msg, ok) => {
  const t = document.getElementById('toast');
  t.className = `toast ${ok ? 'ok' : 'err'} show`;
  document.getElementById('toastMsg').textContent = msg;
  clearTimeout(toastT); toastT = setTimeout(() => t.classList.remove('show'), 3200);
};
</script>

<style>
:root{
  --bg:#07101e;--bg2:#0c1829;--bg3:#111f38;
  --border:rgba(0,212,255,.10);--border2:rgba(0,212,255,.26);
  --cyan:#00d4ff;--teal:#00e5c3;--purple:#7c5cbf;
  --txt:#e2e8f0;--muted:#64748b;--dim:#94a3b8;
  --danger:#f43f5e;--success:#22c55e;--warn:#f59e0b;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--txt);font-family:'Outfit',sans-serif;height:100vh;overflow:hidden;display:flex;flex-direction:column;}
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background:radial-gradient(ellipse 60% 50% at 85% 5%,rgba(0,212,255,.05) 0,transparent 60%),
             radial-gradient(ellipse 50% 60% at 5% 95%,rgba(124,92,191,.06) 0,transparent 60%);}

/* NAV */
nav{position:relative;z-index:100;flex-shrink:0;height:54px;display:flex;align-items:center;justify-content:space-between;
  padding:0 20px;background:rgba(7,16,30,.96);border-bottom:1px solid var(--border);backdrop-filter:blur(20px);}
.nav-logo{font-family:'Cinzel',serif;font-size:1.08rem;letter-spacing:.06em;
  background:linear-gradient(90deg,var(--purple),var(--cyan),var(--teal));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;}

/* APP LAYOUT */
.app{display:flex;flex:1;overflow:hidden;position:relative;z-index:1;}

/* â”€â”€ SIDEBAR â”€â”€ */
.sidebar{width:280px;flex-shrink:0;background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;}

/* My Profile */
.my-strip{padding:13px 14px;border-bottom:1px solid var(--border);background:rgba(0,212,255,.04);display:flex;align-items:center;gap:11px;}
.my-ava{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,var(--purple),var(--cyan));
  display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.9rem;
  flex-shrink:0;overflow:hidden;border:2px solid rgba(0,212,255,.3);}
.my-det{flex:1;min-width:0;}
.my-nm{font-size:.84rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.my-em{font-size:.68rem;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.id-pill{display:inline-flex;align-items:center;gap:5px;margin-top:4px;font-size:.7rem;color:var(--cyan);
  font-weight:700;letter-spacing:.05em;background:rgba(0,212,255,.1);padding:2px 9px;border-radius:9px;
  border:1px solid rgba(0,212,255,.22);cursor:pointer;transition:all .2s;}
.id-pill:hover{background:rgba(0,212,255,.22);}
.so-btn{background:none;border:none;color:var(--muted);cursor:pointer;padding:6px;border-radius:8px;transition:all .2s;flex-shrink:0;}
.so-btn:hover{background:rgba(244,63,94,.12);color:var(--danger);}

/* Sidebar tools */
.sb-tools{padding:10px 11px 5px;display:flex;gap:8px;}
.sb-srch{flex:1;background:var(--bg3);border:1px solid var(--border);border-radius:10px;display:flex;align-items:center;gap:7px;padding:7px 11px;}
.sb-srch input{background:none;border:none;outline:none;color:var(--txt);font-size:.8rem;flex:1;font-family:'Outfit',sans-serif;}
.sb-srch input::placeholder{color:var(--muted);}
.add-btn{background:linear-gradient(135deg,rgba(0,212,255,.18),rgba(0,229,195,.1));border:1px solid var(--border2);
  border-radius:10px;color:var(--cyan);width:36px;height:36px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;flex-shrink:0;}
.add-btn:hover{background:rgba(0,212,255,.3);box-shadow:0 0 14px rgba(0,212,255,.2);}

/* Contact List */
.contact-list{flex:1;overflow-y:auto;padding:5px 8px 8px;}
.contact-list::-webkit-scrollbar{width:3px;}
.contact-list::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}
.empty-list{text-align:center;padding:20px 14px;color:var(--muted);font-size:.8rem;line-height:1.95;}

.contact-row{display:flex;align-items:center;gap:11px;padding:10px 12px;border-radius:12px;cursor:pointer;
  border:1px solid transparent;margin-bottom:4px;transition:all .2s;animation:slin .3s ease both;}
@keyframes slin{from{opacity:0;transform:translateX(-12px)}to{opacity:1;transform:translateX(0)}}
.contact-row:hover{background:var(--bg3);border-color:var(--border);}
.contact-row.active{background:rgba(0,212,255,.1);border-color:rgba(0,212,255,.28);}
.c-inf{flex:1;min-width:0;}
.c-nm{font-size:.84rem;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.c-id{font-size:.7rem;color:var(--muted);margin-top:2px;}
.rm-btn{opacity:0;transition:opacity .2s;background:none;border:none;cursor:pointer;color:var(--danger);padding:5px;border-radius:7px;flex-shrink:0;}
.contact-row:hover .rm-btn{opacity:1;}
.rm-btn:hover{background:rgba(244,63,94,.15);}

.odot{position:absolute;bottom:1px;right:1px;width:11px;height:11px;border-radius:50%;border:2px solid var(--bg2);}
.odot.on{background:var(--success);}
.odot.off{background:var(--muted);}

/* Avatar colors */
.ac0{background:linear-gradient(135deg,#7c5cbf,#60a5fa)}
.ac1{background:linear-gradient(135deg,#00d4ff,#00e5c3)}
.ac2{background:linear-gradient(135deg,#f59e0b,#f43f5e)}
.ac3{background:linear-gradient(135deg,#a78bfa,#ec4899)}
.ac4{background:linear-gradient(135deg,#10b981,#06b6d4)}
.ac5{background:linear-gradient(135deg,#f97316,#eab308)}

/* â”€â”€ CHAT PANEL â”€â”€ */
.chat-panel{flex:1;display:flex;flex-direction:column;overflow:hidden;}

.chat-welcome{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;text-align:center;padding:30px;}
.cw-logo{font-family:'Cinzel',serif;font-size:2.8rem;font-weight:700;
  background:linear-gradient(90deg,var(--purple),var(--cyan),var(--teal));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  animation:float 4s ease-in-out infinite;}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
.cw-sub{color:var(--muted);font-size:.87rem;max-width:300px;line-height:1.75;}

/* Chat box */
#chatBox{display:none;}
.chat-hd{display:flex;align-items:center;justify-content:space-between;padding:11px 20px;
  border-bottom:1px solid var(--border);background:rgba(7,16,30,.9);backdrop-filter:blur(12px);flex-shrink:0;}
.ch-l{display:flex;align-items:center;gap:12px;}

/* Messages */
.msg-area{flex:1;overflow-y:auto;padding:16px 20px;display:flex;flex-direction:column;gap:7px;scroll-behavior:smooth;}
.msg-area::-webkit-scrollbar{width:4px;}
.msg-area::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}
.day-sep{text-align:center;font-size:.69rem;color:var(--muted);padding:4px 14px;border-radius:10px;
  background:rgba(255,255,255,.04);border:1px solid var(--border);margin:6px auto;width:fit-content;}

.msg-r{display:flex;gap:8px;animation:msin .26s ease both;}
@keyframes msin{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.msg-r.me{flex-direction:row-reverse;}
.msg-col{display:flex;flex-direction:column;gap:3px;max-width:63%;}
.msg-r.me .msg-col{align-items:flex-end;}

.bbl{padding:10px 14px;border-radius:16px;font-size:.86rem;line-height:1.55;word-break:break-word;}
.bbl.me{background:linear-gradient(135deg,rgba(0,212,255,.2),rgba(0,229,195,.14));border:1px solid rgba(0,212,255,.32);border-bottom-right-radius:4px;}
.bbl.them{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.09);border-bottom-left-radius:4px;}

.media-wrap{border-radius:14px;overflow:hidden;border:1px solid var(--border2);cursor:zoom-in;}
.file-row{display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--bg3);border:1px solid var(--border2);border-radius:13px;cursor:pointer;min-width:170px;transition:border-color .2s;}
.file-row:hover{border-color:var(--cyan);}
.fn{font-size:.8rem;font-weight:500;}
.fsz{font-size:.7rem;color:var(--muted);margin-top:2px;}
.msg-meta{font-size:.64rem;color:var(--muted);display:flex;align-items:center;gap:4px;}

/* Input area */
.input-area{padding:11px 15px;border-top:1px solid var(--border);background:rgba(7,16,30,.9);flex-shrink:0;position:relative;}
.input-row{display:flex;align-items:flex-end;gap:8px;}
.tool-btn{background:none;border:none;color:var(--muted);cursor:pointer;width:34px;height:34px;border-radius:9px;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0;}
.tool-btn:hover{background:rgba(0,212,255,.1);color:var(--cyan);}
.inp-wrap{flex:1;background:var(--bg3);border:1px solid var(--border);border-radius:14px;display:flex;align-items:flex-end;padding:8px 12px;gap:8px;transition:border-color .2s;}
.inp-wrap:focus-within{border-color:var(--cyan);}
.msg-inp{flex:1;background:none;border:none;outline:none;color:var(--txt);font-family:'Outfit',sans-serif;font-size:.87rem;resize:none;max-height:120px;line-height:1.5;min-height:22px;}
.msg-inp::placeholder{color:var(--muted);}
.send-btn{width:38px;height:38px;border-radius:50%;border:none;cursor:pointer;background:linear-gradient(135deg,var(--cyan),var(--teal));
  display:flex;align-items:center;justify-content:center;flex-shrink:0;box-shadow:0 0 14px rgba(0,212,255,.3);transition:all .2s;}
.send-btn:hover{box-shadow:0 0 24px rgba(0,212,255,.6);transform:scale(1.08);}
.send-btn:active{transform:scale(.95);}
.send-btn svg{width:16px;height:16px;fill:#07101e;}

/* Emoji */
.emoji-pad{position:absolute;bottom:66px;left:15px;z-index:200;background:var(--bg2);border:1px solid var(--border2);
  border-radius:14px;padding:11px;display:none;grid-template-columns:repeat(8,1fr);gap:5px;box-shadow:0 8px 32px rgba(0,0,0,.5);}
.emoji-pad span{font-size:1.28rem;cursor:pointer;text-align:center;padding:4px;border-radius:8px;transition:background .15s;line-height:1;}
.emoji-pad span:hover{background:rgba(255,255,255,.1);}

/* â”€â”€ LOGIN SCREEN â”€â”€ */
#loginScreen{position:fixed;inset:0;z-index:500;background:var(--bg);display:flex;align-items:center;justify-content:center;}
.lo{position:absolute;border-radius:50%;filter:blur(80px);opacity:.4;animation:drift 12s ease-in-out infinite;}
.lo1{width:500px;height:500px;background:radial-gradient(circle,rgba(124,92,191,.25),transparent 70%);top:-150px;left:-100px;}
.lo2{width:400px;height:400px;background:radial-gradient(circle,rgba(0,212,255,.15),transparent 70%);bottom:-100px;right:-80px;animation-delay:-5s;}
@keyframes drift{0%,100%{transform:translate(0,0)}33%{transform:translate(28px,-18px)}66%{transform:translate(-18px,28px)}}

.login-card{position:relative;z-index:1;width:min(430px,92vw);background:rgba(12,24,41,.9);
  border:1px solid var(--border2);border-radius:24px;padding:40px 36px;backdrop-filter:blur(40px);
  box-shadow:0 32px 80px rgba(0,0,0,.6),inset 0 1px 0 rgba(255,255,255,.06);
  animation:cpop .7s cubic-bezier(.34,1.36,.64,1) both;}
@keyframes cpop{from{opacity:0;transform:translateY(30px) scale(.95)}to{opacity:1;transform:none}}
.login-card::before{content:'';position:absolute;top:0;left:15%;right:15%;height:1px;
  background:linear-gradient(90deg,transparent,var(--cyan),var(--teal),transparent);opacity:.6;}
.big-logo{font-family:'Cinzel',serif;font-size:2.5rem;font-weight:700;letter-spacing:.06em;
  background:linear-gradient(135deg,var(--purple),var(--cyan),var(--teal));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;text-align:center;}
.tagline{text-align:center;font-size:.75rem;color:var(--muted);letter-spacing:.14em;text-transform:uppercase;margin:5px 0 26px;}
.login-desc{font-size:.87rem;color:var(--dim);text-align:center;line-height:1.75;margin-bottom:24px;}
.google-btn{width:100%;display:flex;align-items:center;justify-content:center;gap:12px;
  padding:14px 22px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.16);
  border-radius:14px;cursor:pointer;font-family:'Outfit',sans-serif;font-size:.92rem;font-weight:600;color:var(--txt);transition:all .25s;}
.google-btn:hover:not(:disabled){border-color:rgba(0,212,255,.4);background:rgba(0,212,255,.08);transform:translateY(-2px);box-shadow:0 8px 28px rgba(0,0,0,.3);}
.google-btn:disabled{opacity:.7;pointer-events:none;}
.auth-err{margin-top:13px;padding:10px 14px;background:rgba(244,63,94,.1);border:1px solid rgba(244,63,94,.3);border-radius:10px;font-size:.8rem;color:#f87171;display:none;}
.feats{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:24px;}
.ft{display:flex;align-items:center;gap:8px;padding:9px 12px;background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:10px;font-size:.77rem;color:var(--muted);}
.spin{width:18px;height:18px;border:2px solid rgba(0,212,255,.3);border-top-color:var(--cyan);border-radius:50%;animation:sp .6s linear infinite;flex-shrink:0;}
@keyframes sp{to{transform:rotate(360deg)}}

/* â”€â”€ MODAL â”€â”€ */
.overlay{display:none;position:fixed;inset:0;z-index:300;background:rgba(0,0,0,.72);backdrop-filter:blur(10px);align-items:center;justify-content:center;}
.modal-box{background:var(--bg2);border:1px solid var(--border2);border-radius:20px;width:min(430px,92vw);padding:26px;animation:mpop .28s cubic-bezier(.34,1.56,.64,1) both;}
@keyframes mpop{from{opacity:0;transform:scale(.93) translateY(18px)}to{opacity:1;transform:none}}
.modal-title{font-family:'Cinzel',serif;font-size:.98rem;font-weight:600;
  background:linear-gradient(90deg,var(--cyan),var(--teal));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:16px;}
.id-row{display:flex;gap:9px;}
.id-inp{flex:1;background:var(--bg3);border:1px solid var(--border);border-radius:11px;color:var(--txt);
  font-family:'Outfit',sans-serif;font-size:.9rem;padding:10px 14px;outline:none;transition:border-color .2s;
  letter-spacing:.07em;text-transform:uppercase;}
.id-inp:focus{border-color:var(--cyan);}
.btn-teal{background:linear-gradient(135deg,var(--cyan),var(--teal));border:none;color:#07101e;font-weight:700;font-size:.84rem;
  padding:10px 18px;border-radius:11px;cursor:pointer;font-family:'Outfit',sans-serif;transition:all .2s;white-space:nowrap;}
.btn-teal:hover{box-shadow:0 0 20px rgba(0,212,255,.4);}
.btn-teal-sm{background:linear-gradient(135deg,var(--cyan),var(--teal));border:none;color:#07101e;font-weight:700;
  font-size:.76rem;padding:7px 16px;border-radius:9px;cursor:pointer;font-family:'Outfit',sans-serif;white-space:nowrap;}
.found-card{display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg3);border:1px solid var(--border2);border-radius:12px;margin-top:12px;}
.find-err{font-size:.82rem;color:var(--danger);padding:10px 0;}
.modal-hint{font-size:.75rem;color:var(--muted);margin-top:14px;line-height:1.75;}
.m-close{float:right;background:none;border:none;color:var(--muted);cursor:pointer;font-size:1.1rem;padding:2px 4px;border-radius:6px;}
.m-close:hover{color:var(--txt);}
.icon-btn{background:rgba(255,255,255,.06);border:1px solid var(--border);color:var(--dim);border-radius:9px;
  width:34px;height:34px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;}
.icon-btn:hover{border-color:var(--border2);color:var(--txt);}

/* â”€â”€ HOW IT WORKS banner â”€â”€ */
.how-banner{margin:0 8px 8px;padding:11px 14px;background:rgba(0,212,255,.06);border:1px solid rgba(0,212,255,.2);border-radius:12px;font-size:.75rem;color:var(--dim);line-height:1.7;}
.how-banner strong{color:var(--cyan);}

/* Lightbox */
#lb{display:none;position:fixed;inset:0;z-index:600;background:rgba(0,0,0,.93);align-items:center;justify-content:center;cursor:zoom-out;backdrop-filter:blur(8px);}
#lb img{max-width:90vw;max-height:88vh;border-radius:12px;object-fit:contain;}
.lb-x{position:absolute;top:18px;right:18px;background:rgba(255,255,255,.1);border:none;color:#fff;width:36px;height:36px;border-radius:50%;cursor:pointer;font-size:1rem;display:flex;align-items:center;justify-content:center;}

/* Toast */
.toast{position:fixed;bottom:20px;right:20px;z-index:999;background:var(--bg2);border:1px solid var(--border2);border-radius:12px;
  padding:11px 18px;font-size:.8rem;display:flex;align-items:center;gap:9px;
  transform:translateY(80px);opacity:0;transition:all .35s cubic-bezier(.34,1.56,.64,1);pointer-events:none;}
.toast.show{transform:translateY(0);opacity:1;}
.toast.ok{border-color:rgba(34,197,94,.4);}.toast.ok .td{background:var(--success);}
.toast.err{border-color:rgba(244,63,94,.4);}.toast.err .td{background:var(--danger);}
.td{width:7px;height:7px;border-radius:50%;background:var(--warn);flex-shrink:0;}
#imgIn,#fileIn{display:none;}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen">
  <div class="lo lo1"></div>
  <div class="lo lo2"></div>
  <div class="login-card">
    <div class="big-logo">NILLA.ai</div>
    <div class="tagline">Private Messenger</div>
    <p class="login-desc">
      Sign in with Google to get your unique ID.<br>
      Share it with friends â€” when they message you, they appear in your contacts <strong style="color:var(--cyan)">automatically</strong>.
    </p>
    <button class="google-btn" id="googleBtn" onclick="doGoogleSignIn()">
      <svg width="20" height="20" viewBox="0 0 24 24">
        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
      </svg>
      <span>Continue with Google</span>
    </button>
    <div class="auth-err" id="authErr"></div>
    <div class="feats">
      <div class="ft">ğŸ”‘ Unique ID per user</div>
      <div class="ft">âš¡ Auto-add on message</div>
      <div class="ft">ğŸ’¬ Real-time chat</div>
      <div class="ft">ğŸ”’ Contacts saved forever</div>
    </div>
  </div>
</div>

<!-- APP -->
<nav>
  <div class="nav-logo">NILLA.ai</div>
  <span style="font-size:.7rem;color:var(--muted);letter-spacing:.06em">Messenger</span>
</nav>

<div class="app" id="appScreen" style="display:none">

  <!-- SIDEBAR -->
  <aside class="sidebar">

    <!-- My profile -->
    <div class="my-strip">
      <div class="my-ava" id="myAva"></div>
      <div class="my-det">
        <div class="my-nm" id="myName"></div>
        <div class="my-em" id="myEmail"></div>
        <div class="id-pill" onclick="copyMyId()" title="Tap to copy your ID">
          <span id="myShortId"></span>
          <svg width="10" height="10" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
          </svg>
        </div>
      </div>
      <button class="so-btn" onclick="doSignOut()" title="Sign out">
        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9"/>
        </svg>
      </button>
    </div>

    <!-- Search + Add button -->
    <div class="sb-tools">
      <div class="sb-srch">
        <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <circle cx="11" cy="11" r="7"/><path d="m16.5 16.5 4 4"/>
        </svg>
        <input id="searchContacts" placeholder="Search contactsâ€¦" oninput="renderContactList()">
      </div>
      <button class="add-btn" onclick="openAddModal()" title="Find someone by ID">
        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
          <path d="M12 5v14M5 12h14"/>
        </svg>
      </button>
    </div>

    <!-- How it works hint -->
    <div class="how-banner">
      ğŸ“¨ Message someone first using <strong>+</strong><br>
      They'll see you in their list <strong>automatically</strong> â€” no search needed!
    </div>

    <!-- Contact list -->
    <div class="contact-list" id="contactList">
      <div class="empty-list" style="padding-top:30px">
        <div style="font-size:1.6rem;margin-bottom:10px">ğŸ’¬</div>
        <div>No contacts yet.</div>
        <div style="margin-top:8px">Tap <strong style="color:var(--cyan)">+</strong> and search by ID to start!</div>
      </div>
    </div>
  </aside>

  <!-- CHAT PANEL -->
  <div class="chat-panel">

    <!-- Welcome state -->
    <div class="chat-welcome" id="chatWelcome">
      <div class="cw-logo">Nilla</div>
      <p class="cw-sub">Select a contact to chat. When you send a message, the other person sees you in their contacts automatically â€” no search needed!</p>
      <div style="margin-top:12px;font-size:.8rem;color:var(--muted)">
        Your ID:
        <span id="myIdInline" style="color:var(--cyan);font-weight:700;cursor:pointer;letter-spacing:.04em" onclick="copyMyId()"></span>
        <span style="opacity:.7"> â€” share this to receive messages</span>
      </div>
    </div>

    <!-- Active chat -->
    <div id="chatBox">
      <div class="chat-hd" id="chatHeader"></div>
      <div class="msg-area" id="msgArea"></div>
      <div class="input-area">
        <div class="emoji-pad" id="emojiPad"></div>
        <div class="input-row">
          <button class="tool-btn" onclick="document.getElementById('imgIn').click()" title="Send Image">
            <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24">
              <rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/>
              <path d="m21 15-5-5L5 21"/>
            </svg>
          </button>
          <button class="tool-btn" onclick="document.getElementById('fileIn').click()" title="Attach File">
            <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24">
              <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
            </svg>
          </button>
          <button class="tool-btn" onclick="toggleEm()" title="Emoji">
            <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="10"/><path d="M8 13s1.5 2 4 2 4-2 4-2M9 9h.01M15 9h.01"/>
            </svg>
          </button>
          <div class="inp-wrap">
            <textarea class="msg-inp" id="msgInput" placeholder="Type a messageâ€¦" rows="1"
              oninput="autoH(this)" onkeydown="keydown(event)"></textarea>
          </div>
          <button class="send-btn" onclick="sendMsg()">
            <svg viewBox="0 0 24 24"><path d="M22 2 11 13M22 2 15 22 11 13 2 9l20-7z"/></svg>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ADD CONTACT MODAL -->
<div class="overlay" id="addModal" style="display:none">
  <div class="modal-box">
    <button class="m-close" onclick="closeAddModal()">âœ•</button>
    <div class="modal-title">Find Someone by ID</div>
    <div class="id-row">
      <input class="id-inp" id="addIdInput" placeholder="e.g. A1B2C3D4" maxlength="8"
        onkeydown="if(event.key==='Enter') searchAndAdd()">
      <button class="btn-teal" onclick="searchAndAdd()">Find</button>
    </div>
    <div id="findResult"></div>
    <p class="modal-hint">
      ğŸ’¡ <strong>Sender:</strong> Enter friend's ID â†’ Add &amp; Chat â†’ send first message.<br>
      ğŸ’¡ <strong>Receiver:</strong> No action needed â€” you'll appear in their list <strong style="color:var(--cyan)">automatically</strong> once they send a message!
    </p>
  </div>
</div>

<!-- LIGHTBOX -->
<div id="lb" onclick="closeLb()">
  <button class="lb-x" onclick="closeLb()">âœ•</button>
  <img id="lbImg" src="" alt="">
</div>

<!-- TOAST -->
<div class="toast" id="toast"><span class="td"></span><span id="toastMsg"></span></div>

<!-- Hidden file inputs -->
<input type="file" id="imgIn" accept="image/*" onchange="handleImg(this)">
<input type="file" id="fileIn" multiple onchange="handleFile(this)">

<script>
// Build emoji pad
const EP = document.getElementById('emojiPad');
['ğŸ˜Š','ğŸ˜‚','â¤ï¸','ğŸ‘','ğŸ”¥','âœ¨','ğŸ‰','ğŸ˜','ğŸ™','ğŸ’¯','ğŸš€','ğŸ’¡','ğŸ‘‹','ğŸ˜','ğŸ¤”','ğŸ˜…','ğŸ¯','ğŸ’ª','ğŸŒŸ','ğŸ˜˜','ğŸ¥°','ğŸ˜œ','ğŸ¤—','ğŸ˜‡'].forEach(e => {
  const s = document.createElement('span');
  s.textContent = e;
  s.onclick = () => addEmoji(e);
  EP.appendChild(s);
});

// Close modal on backdrop click
document.getElementById('addModal').addEventListener('click', e => {
  if (e.target === document.getElementById('addModal')) closeAddModal();
});

// Close emoji on outside click
document.addEventListener('click', e => {
  const ep = document.getElementById('emojiPad');
  if (ep && ep.style.display === 'grid' &&
      !e.target.closest('#emojiPad') && !e.target.closest('.tool-btn')) {
    ep.style.display = 'none';
  }
});

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') { closeAddModal(); closeLb(); }
});
</script>
</body>
</html>
