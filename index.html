<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NILLA.ai â€” Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">

<script type="module">
import { initializeApp }        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged }
                                from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getDatabase, ref, set, get, push, onValue, off, serverTimestamp, query, orderByChild }
                                from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

// ğŸ”¥ YOUR FIREBASE CONFIG
 const firebaseConfig = {
    apiKey: "AIzaSyBr5LtEwkHDau2oUcSK0czVZH76qjdM6-8",
    authDomain: "ap-cont.firebaseapp.com",
    databaseURL: "https://ap-cont-default-rtdb.firebaseio.com",
    projectId: "ap-cont",
    storageBucket: "ap-cont.appspot.com",
    messagingSenderId: "325531671266",
    appId: "1:325531671266:web:9a0ffa629fc2d730c89cbb",
    measurementId: "G-BK71M75BK3"
  };


const app      = initializeApp(firebaseConfig);
const auth     = getAuth(app);
const db       = getDatabase(app);
const provider = new GoogleAuthProvider();

let currentUser   = null;
let activeChatId  = null;
let msgListener   = null;
let usersListener = null;
let allUsers      = {};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GENERATE SHORT UNIQUE ID
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function genUID(uid) {
  // Use first 8 chars of Firebase UID for short readable ID
  return uid.substring(0, 8).toUpperCase();
}

function makeChatId(uid1, uid2) {
  return [uid1, uid2].sort().join('__');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.doGoogleSignIn = async () => {
  try {
    setBtnLoading(true);
    const result = await signInWithPopup(auth, provider);
    const u = result.user;
    const shortId = genUID(u.uid);

    await set(ref(db, `nilla_users/${u.uid}`), {
      uid:      u.uid,
      shortId:  shortId,
      name:     u.displayName,
      email:    u.email,
      photo:    u.photoURL || '',
      online:   true,
      lastSeen: serverTimestamp()
    });
  } catch(e) {
    setBtnLoading(false);
    showAuthError(e.code === 'auth/popup-closed-by-user'
      ? 'Sign-in cancelled.' : 'Error: ' + e.message);
  }
};

window.doSignOut = async () => {
  if (currentUser) {
    await set(ref(db, `nilla_users/${currentUser.uid}/online`), false);
    await set(ref(db, `nilla_users/${currentUser.uid}/lastSeen`), serverTimestamp());
  }
  await signOut(auth);
};

onAuthStateChanged(auth, async user => {
  if (user) {
    currentUser = user;
    setBtnLoading(false);
    showApp(user);
    startListeningUsers();
  } else {
    currentUser = null;
    if (usersListener) off(ref(db, 'nilla_users'), 'value', usersListener);
    showLogin();
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  USERS â€” listen all
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startListeningUsers() {
  const r = ref(db, 'nilla_users');
  onValue(r, snap => {
    allUsers = snap.val() || {};
    renderUserList();
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UI â€” AUTH SCREEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showLogin() {
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('appScreen').style.display   = 'none';
}

function showApp(user) {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('appScreen').style.display   = 'flex';

  const shortId = genUID(user.uid);
  document.getElementById('myName').textContent  = user.displayName || 'User';
  document.getElementById('myId').textContent    = '#' + shortId;
  document.getElementById('myEmail').textContent = user.email;

  if (user.photoURL) {
    document.getElementById('myAvatar').innerHTML =
      `<img src="${user.photoURL}" style="width:100%;height:100%;border-radius:50%;object-fit:cover">`;
  } else {
    document.getElementById('myAvatar').textContent =
      (user.displayName||'U')[0].toUpperCase();
  }
}

function setBtnLoading(on) {
  const btn = document.getElementById('googleBtn');
  if (on) {
    btn.disabled = true;
    btn.innerHTML = `<div class="spin"></div><span>Signing inâ€¦</span>`;
  } else {
    btn.disabled = false;
    btn.innerHTML = `
      <svg width="20" height="20" viewBox="0 0 24 24">
        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
      </svg>
      <span>Continue with Google</span>`;
  }
}

function showAuthError(msg) {
  const el = document.getElementById('authError');
  el.textContent = msg;
  el.style.display = 'block';
  setTimeout(() => el.style.display = 'none', 4000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  USER LIST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.renderUserList = function() {
  if (!currentUser) return;
  const q   = (document.getElementById('searchUsers')?.value || '').toLowerCase();
  const container = document.getElementById('userList');

  const others = Object.values(allUsers).filter(u =>
    u.uid !== currentUser.uid &&
    (u.name?.toLowerCase().includes(q) ||
     u.shortId?.toLowerCase().includes(q) ||
     u.email?.toLowerCase().includes(q))
  );

  if (!others.length) {
    container.innerHTML = `<div class="empty-list">${q ? 'No users found.' : 'No other users yet.<br>Share the app link!'}</div>`;
    return;
  }

  container.innerHTML = others.map((u, i) => {
    const chatId = makeChatId(currentUser.uid, u.uid);
    const isActive = chatId === activeChatId;
    const isOnline = u.online === true;
    return `
      <div class="user-row ${isActive ? 'active' : ''}" onclick="openChat('${u.uid}')"
           style="animation-delay:${i*0.04}s">
        <div class="u-ava-wrap">
          <div class="u-ava ${avatarColor(u.name||'')}">
            ${u.photo
              ? `<img src="${u.photo}" style="width:100%;height:100%;border-radius:50%;object-fit:cover">`
              : initials(u.name||'?')}
          </div>
          <div class="online-dot ${isOnline ? 'on' : 'off'}"></div>
        </div>
        <div class="u-info">
          <div class="u-name">${esc(u.name||'Unknown')}</div>
          <div class="u-id">#${esc(u.shortId||'')}</div>
        </div>
        <div class="u-status">${isOnline ? '<span class="badge-on">Online</span>' : ''}</div>
      </div>`;
  }).join('');
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  OPEN CHAT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.openChat = function(otherUid) {
  if (!currentUser) return;
  const other = allUsers[otherUid];
  if (!other) return;

  activeChatId = makeChatId(currentUser.uid, otherUid);
  renderUserList();

  // Hide welcome, show chat
  document.getElementById('chatWelcome').style.display = 'none';
  document.getElementById('chatBox').style.display     = 'flex';

  // Header
  const isOnline = other.online === true;
  document.getElementById('chatHeader').innerHTML = `
    <div class="ch-left">
      <div class="u-ava-wrap" style="width:40px;height:40px">
        <div class="u-ava ${avatarColor(other.name||'')}" style="width:40px;height:40px;font-size:.9rem">
          ${other.photo
            ? `<img src="${other.photo}" style="width:100%;height:100%;border-radius:50%;object-fit:cover">`
            : initials(other.name||'?')}
        </div>
        <div class="online-dot ${isOnline?'on':'off'}" style="bottom:0;right:0"></div>
      </div>
      <div>
        <div style="font-weight:600;font-size:.95rem">${esc(other.name||'â€”')}</div>
        <div style="font-size:.72rem;color:${isOnline?'var(--success)':'var(--muted)'}">
          ${isOnline ? 'â— Online' : 'â— Offline'}
          <span style="color:var(--muted);margin-left:8px">#${esc(other.shortId||'')}</span>
        </div>
      </div>
    </div>
    <button class="icon-btn" onclick="closeChatMobile()" title="Back">
      <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path d="M18 6L6 18M6 6l12 12"/>
      </svg>
    </button>
  `;

  // Clear & listen messages
  if (msgListener) {
    off(ref(db, `nilla_chats/${activeChatId}/messages`));
    msgListener = null;
  }
  document.getElementById('msgArea').innerHTML = '';

  const msgsRef = ref(db, `nilla_chats/${activeChatId}/messages`);
  onValue(msgsRef, snap => {
    const data = snap.val() || {};
    const msgs = Object.entries(data)
      .map(([id, v]) => ({ id, ...v }))
      .sort((a, b) => (a.ts||0) - (b.ts||0));
    renderMessages(msgs, otherUid);
  });
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER MESSAGES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMessages(msgs, otherUid) {
  const area   = document.getElementById('msgArea');
  const other  = allUsers[otherUid] || {};

  if (!msgs.length) {
    area.innerHTML = `<div class="msg-day-label">Say hello! ğŸ‘‹</div>`;
    return;
  }

  let html = '';
  let lastDay = '';

  msgs.forEach(m => {
    const isMe  = m.sender === currentUser.uid;
    const day   = fmtDay(m.ts);
    if (day !== lastDay) {
      html += `<div class="msg-day-label">${day}</div>`;
      lastDay = day;
    }

    const ava = isMe
      ? (currentUser.photoURL
          ? `<img src="${currentUser.photoURL}" class="msg-ava" alt="">`
          : `<div class="msg-ava ${avatarColor(currentUser.displayName||'')}">${initials(currentUser.displayName||'?')}</div>`)
      : (other.photo
          ? `<img src="${other.photo}" class="msg-ava" alt="">`
          : `<div class="msg-ava ${avatarColor(other.name||'')}">${initials(other.name||'?')}</div>`);

    let content = '';
    if (m.type === 'text') {
      content = `<div class="bubble ${isMe?'me':'them'}">${esc(m.text).replace(/\n/g,'<br>')}</div>`;
    } else if (m.type === 'image') {
      content = `<div class="media-bub" onclick="lightbox('${m.src}')">
        <img src="${m.src}" style="max-width:220px;max-height:200px;border-radius:12px;display:block;cursor:zoom-in">
      </div>`;
    } else if (m.type === 'file') {
      content = `<div class="file-bub" onclick="dlFile('${m.src}','${esc(m.name)}')">
        <div class="file-ico">ğŸ“</div>
        <div><div class="file-name">${esc(m.name)}</div><div class="file-sz">${m.size||''}</div></div>
      </div>`;
    }

    html += `
      <div class="msg-row ${isMe?'me':'them'}">
        ${!isMe ? ava : ''}
        <div class="msg-col">
          ${content}
          <div class="msg-meta">${fmtTime(m.ts)}${isMe ? ' <span style="color:var(--cyan)">âœ“âœ“</span>' : ''}</div>
        </div>
        ${isMe ? ava : ''}
      </div>`;
  });

  area.innerHTML = html;
  area.scrollTop = area.scrollHeight;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SEND MESSAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.sendMsg = async function() {
  if (!currentUser || !activeChatId) return;
  const inp  = document.getElementById('msgInput');
  const text = inp.value.trim();
  if (!text) return;

  inp.value = '';
  inp.style.height = 'auto';

  const msgsRef = ref(db, `nilla_chats/${activeChatId}/messages`);
  await push(msgsRef, {
    sender: currentUser.uid,
    type:   'text',
    text:   text,
    ts:     serverTimestamp()
  });
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SEND IMAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.handleImagePick = function(input) {
  const file = input.files[0];
  if (!file || !activeChatId) return;
  const reader = new FileReader();
  reader.onload = e => {
    const img = new Image();
    img.onload = async () => {
      const MAX = 700;
      let w = img.width, h = img.height;
      if (w > MAX || h > MAX) {
        if (w > h) { h = Math.round(h*MAX/w); w = MAX; }
        else       { w = Math.round(w*MAX/h); h = MAX; }
      }
      const c = document.createElement('canvas');
      c.width = w; c.height = h;
      c.getContext('2d').drawImage(img, 0, 0, w, h);
      const b64 = c.toDataURL('image/jpeg', 0.78);
      const msgsRef = ref(db, `nilla_chats/${activeChatId}/messages`);
      await push(msgsRef, { sender: currentUser.uid, type: 'image', src: b64, ts: serverTimestamp() });
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
  input.value = '';
};

window.handleFilePick = function(input) {
  const file = input.files[0];
  if (!file || !activeChatId) return;
  const reader = new FileReader();
  reader.onload = async e => {
    const msgsRef = ref(db, `nilla_chats/${activeChatId}/messages`);
    await push(msgsRef, {
      sender: currentUser.uid, type: 'file',
      src: e.target.result, name: file.name,
      size: fmtSize(file.size), ts: serverTimestamp()
    });
  };
  reader.readAsDataURL(file);
  input.value = '';
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ADD USER BY ID
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.findUser = async function() {
  const val = document.getElementById('addIdInput').value.trim().toUpperCase().replace('#','');
  if (!val) return;
  const found = Object.values(allUsers).find(u => u.shortId === val && u.uid !== currentUser?.uid);
  const res   = document.getElementById('findResult');
  if (found) {
    res.innerHTML = `
      <div class="found-card">
        <div class="u-ava ${avatarColor(found.name||'')}" style="width:40px;height:40px;font-size:.9rem">
          ${found.photo ? `<img src="${found.photo}" style="width:100%;height:100%;border-radius:50%;object-fit:cover">` : initials(found.name||'?')}
        </div>
        <div style="flex:1">
          <div style="font-weight:600;font-size:.88rem">${esc(found.name)}</div>
          <div style="font-size:.72rem;color:var(--muted)">#${found.shortId}</div>
        </div>
        <button class="btn-cyan-sm" onclick="openChat('${found.uid}');closeAddModal()">Chat</button>
      </div>`;
  } else {
    res.innerHTML = `<div style="color:var(--danger);font-size:.82rem;padding:8px">User #${val} not found.</div>`;
  }
};

window.closeAddModal = () => {
  document.getElementById('addModal').style.display = 'none';
  document.getElementById('addIdInput').value = '';
  document.getElementById('findResult').innerHTML = '';
};
window.openAddModal = () => {
  document.getElementById('addModal').style.display = 'flex';
  setTimeout(() => document.getElementById('addIdInput').focus(), 100);
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const COLS = ['ac0','ac1','ac2','ac3','ac4','ac5'];
function avatarColor(n){let h=0;for(const c of String(n))h=(h<<5)-h+c.charCodeAt(0);return COLS[Math.abs(h)%COLS.length];}
function initials(n){return String(n).split(' ').slice(0,2).map(w=>w[0]||'').join('').toUpperCase()||'?';}
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function fmtTime(ts){if(!ts)return'now';return new Date(ts).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});}
function fmtDay(ts){if(!ts)return'Today';const d=new Date(ts),t=new Date();if(d.toDateString()===t.toDateString())return'Today';const y=new Date(t);y.setDate(t.getDate()-1);if(d.toDateString()===y.toDateString())return'Yesterday';return d.toLocaleDateString([],{month:'short',day:'numeric',year:'numeric'});}
function fmtSize(b){if(b<1024)return b+'B';if(b<1048576)return(b/1024).toFixed(1)+'KB';return(b/1048576).toFixed(1)+'MB';}
window.lightbox = src => { document.getElementById('lb').style.display='flex'; document.getElementById('lbImg').src=src; };
window.closeLb  = ()  => { document.getElementById('lb').style.display='none'; };
window.dlFile   = (src,name) => { const a=document.createElement('a');a.href=src;a.download=name;a.click(); };
window.closeChatMobile = () => {
  document.getElementById('chatBox').style.display='none';
  document.getElementById('chatWelcome').style.display='flex';
  activeChatId=null; renderUserList();
};

// Enter to send
window.msgKeydown = e => { if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMsg();} };
window.autoH = el => { el.style.height='auto'; el.style.height=Math.min(el.scrollHeight,120)+'px'; };

// Copy own ID
window.copyMyId = () => {
  if(!currentUser) return;
  navigator.clipboard.writeText('#'+genUID(currentUser.uid))
    .then(()=>showToast('ID copied! Share it with friends âœ“',true))
    .catch(()=>{});
};

// Toast
let toastT;
window.showToast = (msg,ok) => {
  const t=document.getElementById('toast');
  t.className=`toast ${ok?'ok':'err'} show`;
  document.getElementById('toastMsg').textContent=msg;
  clearTimeout(toastT);
  toastT=setTimeout(()=>t.classList.remove('show'),3000);
};

// Emoji
const EMOJIS=['ğŸ˜Š','ğŸ˜‚','â¤ï¸','ğŸ‘','ğŸ”¥','âœ¨','ğŸ‰','ğŸ˜','ğŸ™','ğŸ’¯','ğŸš€','ğŸ’¡','ğŸ‘‹','ğŸ˜','ğŸ¤”','ğŸ˜…','ğŸ¯','ğŸ’ª','ğŸŒŸ','ğŸ˜˜','ğŸ¥°','ğŸ˜œ','ğŸ¤—','ğŸ˜‡'];
window.toggleEmoji = () => {
  const p=document.getElementById('emojiPad');
  p.style.display=p.style.display==='grid'?'none':'grid';
};
window.addEmoji = e => {
  const inp=document.getElementById('msgInput');
  inp.value+=e; inp.focus();
  document.getElementById('emojiPad').style.display='none';
};
</script>

<style>
:root{
  --bg:#07101e; --bg2:#0c1829; --bg3:#111f38; --card:#0e1d35;
  --border:rgba(0,212,255,.10); --border2:rgba(0,212,255,.26);
  --cyan:#00d4ff; --teal:#00e5c3; --purple:#7c5cbf; --lav:#a78bfa;
  --txt:#e2e8f0; --muted:#64748b; --dim:#94a3b8;
  --danger:#f43f5e; --success:#22c55e; --warn:#f59e0b;
  --r:14px;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--txt);font-family:'Outfit',sans-serif;height:100vh;overflow:hidden;display:flex;flex-direction:column;}
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background:
    radial-gradient(ellipse 60% 50% at 85% 5%, rgba(0,212,255,.05) 0,transparent 60%),
    radial-gradient(ellipse 50% 60% at 5% 95%, rgba(124,92,191,.06) 0,transparent 60%);}

/* â”€â”€ NAV â”€â”€ */
nav{position:relative;z-index:100;flex-shrink:0;height:56px;
  display:flex;align-items:center;justify-content:space-between;padding:0 20px;
  background:rgba(7,16,30,.95);border-bottom:1px solid var(--border);backdrop-filter:blur(20px);}
.nav-logo{font-family:'Cinzel',serif;font-size:1.1rem;letter-spacing:.06em;
  background:linear-gradient(90deg,var(--purple),var(--cyan),var(--teal));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.nav-r{display:flex;align-items:center;gap:10px;}

/* â”€â”€ APP LAYOUT â”€â”€ */
.app-layout{display:flex;flex:1;overflow:hidden;position:relative;z-index:1;}

/* â”€â”€ SIDEBAR â”€â”€ */
.sidebar{width:280px;flex-shrink:0;background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;}

/* My profile strip */
.my-profile{
  padding:14px 16px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:12px;
  background:rgba(0,212,255,.04);
}
.my-ava{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,var(--purple),var(--cyan));
  display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.9rem;
  flex-shrink:0;overflow:hidden;border:2px solid rgba(0,212,255,.3);}
.my-details{flex:1;min-width:0;}
.my-name{font-size:.85rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.my-id-row{display:flex;align-items:center;gap:6px;margin-top:3px;}
.my-id{font-size:.72rem;color:var(--cyan);font-weight:600;letter-spacing:.04em;
  background:rgba(0,212,255,.1);padding:2px 8px;border-radius:8px;cursor:pointer;
  border:1px solid rgba(0,212,255,.2);transition:all .2s;}
.my-id:hover{background:rgba(0,212,255,.2);}
.id-copy-hint{font-size:.65rem;color:var(--muted);}
.signout-btn{background:none;border:none;color:var(--muted);cursor:pointer;padding:6px;border-radius:8px;transition:all .2s;}
.signout-btn:hover{background:rgba(244,63,94,.12);color:var(--danger);}

/* Sidebar search + add */
.sb-tools{padding:10px 12px 6px;display:flex;gap:8px;}
.sb-search{flex:1;background:var(--bg3);border:1px solid var(--border);border-radius:10px;
  display:flex;align-items:center;gap:7px;padding:7px 11px;}
.sb-search input{background:none;border:none;outline:none;color:var(--txt);font-size:.8rem;flex:1;font-family:'Outfit',sans-serif;}
.sb-search input::placeholder{color:var(--muted);}
.add-btn{background:linear-gradient(135deg,rgba(0,212,255,.2),rgba(0,229,195,.12));
  border:1px solid var(--border2);border-radius:10px;color:var(--cyan);
  width:36px;height:36px;display:flex;align-items:center;justify-content:center;
  cursor:pointer;transition:all .2s;flex-shrink:0;}
.add-btn:hover{background:rgba(0,212,255,.3);box-shadow:0 0 14px rgba(0,212,255,.2);}

/* User list */
.user-list{flex:1;overflow-y:auto;padding:5px 8px 8px;}
.user-list::-webkit-scrollbar{width:3px;}
.user-list::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}

.user-row{display:flex;align-items:center;gap:11px;padding:10px 12px;border-radius:12px;
  cursor:pointer;border:1px solid transparent;margin-bottom:4px;transition:all .2s;
  animation:slin .3s ease both;}
@keyframes slin{from{opacity:0;transform:translateX(-12px)}to{opacity:1;transform:translateX(0)}}
.user-row:hover{background:var(--bg3);border-color:var(--border);}
.user-row.active{background:rgba(0,212,255,.1);border-color:rgba(0,212,255,.28);}

.u-ava-wrap{position:relative;flex-shrink:0;}
.u-ava{width:42px;height:42px;border-radius:50%;display:flex;align-items:center;justify-content:center;
  font-size:.9rem;font-weight:700;color:#fff;overflow:hidden;border:2px solid rgba(0,212,255,.15);}
.online-dot{position:absolute;bottom:1px;right:1px;width:11px;height:11px;border-radius:50%;border:2px solid var(--bg2);}
.online-dot.on{background:var(--success);}
.online-dot.off{background:var(--muted);}
.u-info{flex:1;min-width:0;}
.u-name{font-size:.84rem;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.u-id{font-size:.7rem;color:var(--muted);margin-top:2px;}
.badge-on{font-size:.65rem;background:rgba(34,197,94,.15);color:var(--success);
  padding:2px 7px;border-radius:8px;border:1px solid rgba(34,197,94,.25);}
.empty-list{text-align:center;padding:36px 14px;color:var(--muted);font-size:.8rem;line-height:1.9;}

/* Avatar colors */
.ac0{background:linear-gradient(135deg,#7c5cbf,#60a5fa)}
.ac1{background:linear-gradient(135deg,#00d4ff,#00e5c3)}
.ac2{background:linear-gradient(135deg,#f59e0b,#f43f5e)}
.ac3{background:linear-gradient(135deg,#a78bfa,#ec4899)}
.ac4{background:linear-gradient(135deg,#10b981,#06b6d4)}
.ac5{background:linear-gradient(135deg,#f97316,#eab308)}

/* â”€â”€ CHAT PANEL â”€â”€ */
.chat-panel{flex:1;display:flex;flex-direction:column;overflow:hidden;position:relative;}

.chat-welcome{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;text-align:center;padding:30px;}
.cw-logo{font-family:'Cinzel',serif;font-size:3rem;font-weight:700;
  background:linear-gradient(90deg,var(--purple),var(--cyan),var(--teal));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  animation:float 4s ease-in-out infinite;}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
.cw-sub{color:var(--muted);font-size:.88rem;max-width:300px;line-height:1.75;}

#chatBox{flex:1;flex-direction:column;overflow:hidden;display:none;}

/* Chat header */
.chat-header{display:flex;align-items:center;justify-content:space-between;
  padding:11px 20px;border-bottom:1px solid var(--border);
  background:rgba(7,16,30,.9);backdrop-filter:blur(12px);flex-shrink:0;}
.ch-left{display:flex;align-items:center;gap:12px;}

/* Messages */
.msg-area{flex:1;overflow-y:auto;padding:16px 20px;display:flex;flex-direction:column;gap:8px;scroll-behavior:smooth;}
.msg-area::-webkit-scrollbar{width:4px;}
.msg-area::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}

.msg-day-label{text-align:center;font-size:.7rem;color:var(--muted);
  padding:4px 14px;border-radius:10px;background:rgba(255,255,255,.04);
  border:1px solid var(--border);margin:6px auto;width:fit-content;}

.msg-row{display:flex;gap:9px;animation:min .28s ease both;}
@keyframes min{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.msg-row.me{flex-direction:row-reverse;}
.msg-col{display:flex;flex-direction:column;gap:3px;max-width:65%;}
.msg-row.me .msg-col{align-items:flex-end;}

.msg-ava{width:28px;height:28px;border-radius:50%;object-fit:cover;flex-shrink:0;align-self:flex-end;border:2px solid rgba(0,212,255,.15);}

.bubble{padding:10px 14px;border-radius:16px;font-size:.86rem;line-height:1.55;word-break:break-word;}
.bubble.me{background:linear-gradient(135deg,rgba(0,212,255,.2),rgba(0,229,195,.14));
  border:1px solid rgba(0,212,255,.32);border-bottom-right-radius:4px;}
.bubble.them{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.09);border-bottom-left-radius:4px;}

.media-bub{border-radius:14px;overflow:hidden;border:1px solid var(--border2);cursor:pointer;}
.file-bub{display:flex;align-items:center;gap:10px;padding:11px 14px;
  background:var(--bg3);border:1px solid var(--border2);border-radius:13px;cursor:pointer;
  transition:all .2s;min-width:180px;}
.file-bub:hover{border-color:var(--cyan);}
.file-ico{font-size:1.4rem;flex-shrink:0;}
.file-name{font-size:.8rem;font-weight:500;}
.file-sz{font-size:.7rem;color:var(--muted);margin-top:2px;}

.msg-meta{font-size:.65rem;color:var(--muted);display:flex;align-items:center;gap:4px;}

/* â”€â”€ INPUT AREA â”€â”€ */
.input-area{padding:12px 16px;border-top:1px solid var(--border);
  background:rgba(7,16,30,.9);flex-shrink:0;position:relative;}
.input-row{display:flex;align-items:flex-end;gap:9px;}
.tool-btn{background:none;border:none;color:var(--muted);cursor:pointer;
  width:34px;height:34px;border-radius:9px;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0;}
.tool-btn:hover{background:rgba(0,212,255,.1);color:var(--cyan);}
.inp-wrap{flex:1;background:var(--bg3);border:1px solid var(--border);
  border-radius:14px;display:flex;align-items:flex-end;padding:8px 13px;gap:8px;transition:border-color .2s;}
.inp-wrap:focus-within{border-color:var(--cyan);}
.msg-inp{flex:1;background:none;border:none;outline:none;color:var(--txt);
  font-family:'Outfit',sans-serif;font-size:.88rem;resize:none;
  max-height:120px;line-height:1.5;min-height:22px;}
.msg-inp::placeholder{color:var(--muted);}
.send-btn{width:38px;height:38px;border-radius:50%;border:none;cursor:pointer;
  background:linear-gradient(135deg,var(--cyan),var(--teal));
  display:flex;align-items:center;justify-content:center;flex-shrink:0;
  box-shadow:0 0 14px rgba(0,212,255,.32);transition:all .2s;}
.send-btn:hover{box-shadow:0 0 24px rgba(0,212,255,.6);transform:scale(1.08);}
.send-btn:active{transform:scale(.95);}
.send-btn svg{width:16px;height:16px;fill:#07101e;}

/* Emoji pad */
.emoji-pad{position:absolute;bottom:68px;left:16px;z-index:200;
  background:var(--bg2);border:1px solid var(--border2);border-radius:14px;padding:12px;
  display:none;grid-template-columns:repeat(8,1fr);gap:6px;
  box-shadow:0 8px 32px rgba(0,0,0,.5);}
.emoji-pad span{font-size:1.3rem;cursor:pointer;text-align:center;
  padding:4px;border-radius:8px;transition:background .15s;line-height:1;}
.emoji-pad span:hover{background:rgba(255,255,255,.1);}

/* â”€â”€ LOGIN SCREEN â”€â”€ */
#loginScreen{position:fixed;inset:0;z-index:500;background:var(--bg);
  display:flex;align-items:center;justify-content:center;}
.login-bg-orb{position:absolute;border-radius:50%;filter:blur(80px);opacity:.4;animation:drift 12s ease-in-out infinite;}
.orb1{width:500px;height:500px;background:radial-gradient(circle,rgba(124,92,191,.25),transparent 70%);top:-150px;left:-100px;}
.orb2{width:400px;height:400px;background:radial-gradient(circle,rgba(0,212,255,.15),transparent 70%);bottom:-100px;right:-80px;animation-delay:-5s;}
@keyframes drift{0%,100%{transform:translate(0,0)}33%{transform:translate(28px,-18px)}66%{transform:translate(-18px,28px)}}

.login-card{position:relative;z-index:1;width:min(420px,92vw);
  background:rgba(12,24,41,.9);border:1px solid var(--border2);
  border-radius:24px;padding:40px 36px;backdrop-filter:blur(40px);
  box-shadow:0 32px 80px rgba(0,0,0,.6),inset 0 1px 0 rgba(255,255,255,.06);
  animation:cardpop .7s cubic-bezier(.34,1.36,.64,1) both;}
@keyframes cardpop{from{opacity:0;transform:translateY(30px) scale(.95)}to{opacity:1;transform:none}}
.login-card::before{content:'';position:absolute;top:0;left:15%;right:15%;height:1px;
  background:linear-gradient(90deg,transparent,var(--cyan),var(--teal),transparent);opacity:.6;}

.login-logo{text-align:center;margin-bottom:32px;}
.big-logo{font-family:'Cinzel',serif;font-size:2.6rem;font-weight:700;letter-spacing:.06em;
  background:linear-gradient(135deg,var(--purple),var(--cyan),var(--teal));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.login-sub{font-size:.78rem;color:var(--muted);letter-spacing:.14em;text-transform:uppercase;margin-top:6px;}

.login-desc{font-size:.88rem;color:var(--dim);text-align:center;line-height:1.7;margin-bottom:28px;}

.google-btn{width:100%;display:flex;align-items:center;justify-content:center;gap:12px;
  padding:14px 22px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.16);
  border-radius:14px;cursor:pointer;font-family:'Outfit',sans-serif;font-size:.92rem;font-weight:600;color:var(--txt);
  transition:all .25s;}
.google-btn:hover{border-color:rgba(0,212,255,.4);background:rgba(0,212,255,.08);transform:translateY(-2px);
  box-shadow:0 8px 28px rgba(0,0,0,.3),0 0 0 1px rgba(0,212,255,.15);}
.google-btn:disabled{opacity:.7;pointer-events:none;}

.auth-error{margin-top:14px;padding:10px 14px;background:rgba(244,63,94,.1);
  border:1px solid rgba(244,63,94,.3);border-radius:10px;font-size:.8rem;color:#f87171;display:none;}

.login-features{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-top:26px;}
.lf{display:flex;align-items:center;gap:8px;padding:9px 12px;
  background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:10px;
  font-size:.77rem;color:var(--muted);}

.spin{width:18px;height:18px;border:2px solid rgba(0,212,255,.3);border-top-color:var(--cyan);
  border-radius:50%;animation:sp .6s linear infinite;flex-shrink:0;}
@keyframes sp{to{transform:rotate(360deg)}}

/* â”€â”€ ADD USER MODAL â”€â”€ */
.overlay{display:none;position:fixed;inset:0;z-index:300;
  background:rgba(0,0,0,.7);backdrop-filter:blur(10px);align-items:center;justify-content:center;}
.overlay.open,.overlay[style*="flex"]{display:flex;}
.modal{background:var(--bg2);border:1px solid var(--border2);border-radius:20px;
  width:min(420px,92vw);padding:26px;animation:mpop .3s cubic-bezier(.34,1.56,.64,1) both;}
@keyframes mpop{from{opacity:0;transform:scale(.93) translateY(20px)}to{opacity:1;transform:none}}
.modal-title{font-family:'Cinzel',serif;font-size:1rem;font-weight:600;
  background:linear-gradient(90deg,var(--cyan),var(--teal));-webkit-background-clip:text;-webkit-text-fill-color:transparent;
  margin-bottom:18px;}
.id-input-row{display:flex;gap:9px;}
.id-input{flex:1;background:var(--bg3);border:1px solid var(--border);border-radius:11px;
  color:var(--txt);font-family:'Outfit',sans-serif;font-size:.9rem;padding:10px 14px;outline:none;
  transition:border-color .2s;letter-spacing:.06em;}
.id-input:focus{border-color:var(--cyan);}
.btn-cyan{background:linear-gradient(135deg,var(--cyan),var(--teal));border:none;color:#07101e;
  font-weight:700;font-size:.84rem;padding:10px 20px;border-radius:11px;cursor:pointer;
  font-family:'Outfit',sans-serif;transition:all .2s;white-space:nowrap;}
.btn-cyan:hover{box-shadow:0 0 20px rgba(0,212,255,.4);}
.btn-cyan-sm{background:linear-gradient(135deg,var(--cyan),var(--teal));border:none;color:#07101e;
  font-weight:700;font-size:.78rem;padding:7px 14px;border-radius:9px;cursor:pointer;font-family:'Outfit',sans-serif;}
.found-card{display:flex;align-items:center;gap:12px;padding:12px;
  background:var(--bg3);border:1px solid var(--border2);border-radius:12px;margin-top:12px;}
.modal-hint{font-size:.75rem;color:var(--muted);margin-top:14px;line-height:1.7;}
.modal-close{background:none;border:none;color:var(--muted);cursor:pointer;font-size:1.1rem;float:right;margin-top:-4px;}

/* â”€â”€ LIGHTBOX â”€â”€ */
#lb{display:none;position:fixed;inset:0;z-index:600;background:rgba(0,0,0,.92);
  align-items:center;justify-content:center;cursor:zoom-out;backdrop-filter:blur(8px);}
#lb img{max-width:90vw;max-height:88vh;border-radius:12px;object-fit:contain;}
.lb-x{position:absolute;top:18px;right:18px;background:rgba(255,255,255,.1);border:none;color:#fff;
  width:36px;height:36px;border-radius:50%;cursor:pointer;font-size:1rem;
  display:flex;align-items:center;justify-content:center;}

/* â”€â”€ TOAST â”€â”€ */
.toast{position:fixed;bottom:20px;right:20px;z-index:999;
  background:var(--bg2);border:1px solid var(--border2);border-radius:12px;
  padding:11px 18px;font-size:.8rem;display:flex;align-items:center;gap:9px;
  transform:translateY(80px);opacity:0;transition:all .35s cubic-bezier(.34,1.56,.64,1);pointer-events:none;}
.toast.show{transform:translateY(0);opacity:1;}
.toast.ok{border-color:rgba(34,197,94,.4);}.toast.ok .td{background:var(--success);}
.toast.err{border-color:rgba(244,63,94,.4);}.toast.err .td{background:var(--danger);}
.td{width:7px;height:7px;border-radius:50%;background:var(--warn);flex-shrink:0;}

/* Buttons */
.icon-btn{background:rgba(255,255,255,.06);border:1px solid var(--border);color:var(--dim);
  border-radius:9px;width:34px;height:34px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;}
.icon-btn:hover{border-color:var(--border2);color:var(--txt);}

/* Hidden inputs */
#imgIn,#fileIn{display:none;}

@media(max-width:640px){
  .sidebar{width:100%;position:absolute;z-index:10;height:100%;}
  .sidebar.hidden{display:none;}
  #chatBox{position:absolute;inset:0;background:var(--bg);z-index:20;}
}
</style>
</head>
<body>

<!-- â•â•â•â• LOGIN SCREEN â•â•â•â• -->
<div id="loginScreen">
  <div class="login-bg-orb orb1"></div>
  <div class="login-bg-orb orb2"></div>
  <div class="login-card">
    <div class="login-logo">
      <div class="big-logo">NILLA.ai</div>
      <div class="login-sub">Real-time Messenger</div>
    </div>
    <p class="login-desc">Sign in with Google to get your unique ID and start private conversations with anyone on the platform.</p>
    <button class="google-btn" id="googleBtn" onclick="doGoogleSignIn()">
      <svg width="20" height="20" viewBox="0 0 24 24">
        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
      </svg>
      <span>Continue with Google</span>
    </button>
    <div class="auth-error" id="authError"></div>
    <div class="login-features">
      <div class="lf">ğŸ”‘ Unique User ID</div>
      <div class="lf">ğŸ’¬ Private Chats</div>
      <div class="lf">ğŸ–¼ï¸ Image & Files</div>
      <div class="lf">âš¡ Real-time Sync</div>
    </div>
  </div>
</div>

<!-- â•â•â•â• MAIN APP â•â•â•â• -->
<nav>
  <div class="nav-logo">NILLA.ai</div>
  <div class="nav-r">
    <span style="font-size:.7rem;color:var(--muted);letter-spacing:.06em">Messenger</span>
  </div>
</nav>

<div class="app-layout" id="appScreen" style="display:none">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <!-- My profile -->
    <div class="my-profile">
      <div class="my-ava" id="myAvatar"></div>
      <div class="my-details">
        <div class="my-name" id="myName"></div>
        <div style="font-size:.7rem;color:var(--muted)" id="myEmail"></div>
        <div class="my-id-row">
          <div class="my-id" id="myId" onclick="copyMyId()" title="Click to copy"></div>
          <span class="id-copy-hint">tap to copy</span>
        </div>
      </div>
      <button class="signout-btn" onclick="doSignOut()" title="Sign out">
        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9"/>
        </svg>
      </button>
    </div>

    <!-- Search + Add -->
    <div class="sb-tools">
      <div class="sb-search">
        <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <circle cx="11" cy="11" r="7"/><path d="m16.5 16.5 4 4"/>
        </svg>
        <input id="searchUsers" placeholder="Search usersâ€¦" oninput="renderUserList()">
      </div>
      <button class="add-btn" onclick="openAddModal()" title="Find user by ID">
        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
          <path d="M12 5v14M5 12h14"/>
        </svg>
      </button>
    </div>

    <!-- User list -->
    <div class="user-list" id="userList">
      <div class="empty-list">Loading usersâ€¦</div>
    </div>
  </aside>

  <!-- CHAT PANEL -->
  <div class="chat-panel">
    <!-- Welcome -->
    <div class="chat-welcome" id="chatWelcome">
      <div class="cw-logo">Nilla</div>
      <p class="cw-sub">Select a user to start chatting, or find someone by their unique ID using the <strong style="color:var(--cyan)">+</strong> button.</p>
      <div style="font-size:.8rem;color:var(--muted);margin-top:8px">
        Your ID: <span id="myIdInline" style="color:var(--cyan);font-weight:600;cursor:pointer" onclick="copyMyId()"></span>
        â€” share this with friends!
      </div>
    </div>

    <!-- Active Chat -->
    <div id="chatBox">
      <div class="chat-header" id="chatHeader"></div>
      <div class="msg-area" id="msgArea"></div>
      <div class="input-area">
        <!-- Emoji pad -->
        <div class="emoji-pad" id="emojiPad">
          <!-- filled by JS -->
        </div>
        <div class="input-row">
          <button class="tool-btn" onclick="document.getElementById('imgIn').click()" title="Image">
            <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24">
              <rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/>
              <path d="m21 15-5-5L5 21"/>
            </svg>
          </button>
          <button class="tool-btn" onclick="document.getElementById('fileIn').click()" title="File">
            <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24">
              <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
            </svg>
          </button>
          <button class="tool-btn" onclick="toggleEmoji()" title="Emoji">
            <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="10"/><path d="M8 13s1.5 2 4 2 4-2 4-2M9 9h.01M15 9h.01"/>
            </svg>
          </button>
          <div class="inp-wrap">
            <textarea class="msg-inp" id="msgInput" placeholder="Type a messageâ€¦" rows="1"
              oninput="autoH(this)" onkeydown="msgKeydown(event)"></textarea>
          </div>
          <button class="send-btn" onclick="sendMsg()">
            <svg viewBox="0 0 24 24"><path d="M22 2 11 13M22 2 15 22 11 13 2 9l20-7z"/></svg>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ADD USER MODAL -->
<div class="overlay" id="addModal" style="display:none">
  <div class="modal">
    <button class="modal-close" onclick="closeAddModal()">âœ•</button>
    <div class="modal-title">Find User by ID</div>
    <div class="id-input-row">
      <input class="id-input" id="addIdInput" placeholder="#XXXXXXXX" maxlength="9"
        oninput="this.value=this.value.toUpperCase()"
        onkeydown="if(event.key==='Enter')findUser()">
      <button class="btn-cyan" onclick="findUser()">Search</button>
    </div>
    <div id="findResult"></div>
    <p class="modal-hint">
      Ask your friend to share their <strong style="color:var(--cyan)">Unique ID</strong> (shown next to their name after login). Enter it above to find and start a chat.
    </p>
  </div>
</div>

<!-- LIGHTBOX -->
<div id="lb" onclick="closeLb()">
  <button class="lb-x" onclick="closeLb()">âœ•</button>
  <img id="lbImg" src="" alt="">
</div>

<!-- TOAST -->
<div class="toast" id="toast"><span class="td"></span><span id="toastMsg"></span></div>

<!-- Hidden file inputs -->
<input type="file" id="imgIn" accept="image/*" onchange="handleImagePick(this)">
<input type="file" id="fileIn" multiple onchange="handleFilePick(this)">

<script>
// Build emoji pad
const EP = document.getElementById('emojiPad');
['ğŸ˜Š','ğŸ˜‚','â¤ï¸','ğŸ‘','ğŸ”¥','âœ¨','ğŸ‰','ğŸ˜','ğŸ™','ğŸ’¯','ğŸš€','ğŸ’¡','ğŸ‘‹','ğŸ˜','ğŸ¤”','ğŸ˜…','ğŸ¯','ğŸ’ª','ğŸŒŸ','ğŸ˜˜','ğŸ¥°','ğŸ˜œ','ğŸ¤—','ğŸ˜‡'].forEach(e => {
  const s = document.createElement('span');
  s.textContent = e;
  s.onclick = () => addEmoji(e);
  EP.appendChild(s);
});

// Update myId in welcome panel after login
const origShowApp = window.showApp; // already defined in module

// Overlay close on bg click
document.getElementById('addModal').addEventListener('click', function(e) {
  if (e.target === this) closeAddModal();
});
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') { closeAddModal(); closeLb(); }
});

// Close emoji on outside click
document.addEventListener('click', e => {
  const ep = document.getElementById('emojiPad');
  if (ep.style.display === 'grid' && !e.target.closest('#emojiPad') && !e.target.closest('.tool-btn')) {
    ep.style.display = 'none';
  }
});

// Update inline ID when shown
const observer = new MutationObserver(() => {
  const id = document.getElementById('myId').textContent;
  document.getElementById('myIdInline').textContent = id;
});
observer.observe(document.getElementById('myId'), { childList: true, characterData: true, subtree: true });
</script>
</body>
</html>
